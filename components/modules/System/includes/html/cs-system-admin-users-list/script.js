// Generated by CoffeeScript 1.9.3

/**
 * @package    CleverStyle CMS
 * @subpackage System module
 * @category   modules
 * @author     Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright  Copyright (c) 2015, Nazar Mokrynskyi
 * @license    MIT License, see license.txt
 */

(function() {
  var GUEST_ID, L, ROOT_ID, STATUS_ACTIVE, STATUS_INACTIVE;

  L = cs.Language;

  STATUS_ACTIVE = 1;

  STATUS_INACTIVE = 0;

  GUEST_ID = 1;

  ROOT_ID = 2;

  Polymer({
    tooltip_animation: '{animation:true,delay:200}',
    L: L,
    search_column: '',
    search_mode: 'LIKE',
    search_text: '',
    search_page: 1,
    search_limit: 20,
    search_columns: [],
    search_modes: [],
    all_columns: [],
    columns: ['id', 'login', 'username', 'email'],
    users: [],
    created: function() {
      $.ajax({
        url: 'api/System/admin/users',
        type: 'search_options',
        success: (function(_this) {
          return function(search_options) {
            var column, i, len, ref, search_columns;
            search_columns = [];
            ref = search_options.columns;
            for (i = 0, len = ref.length; i < len; i++) {
              column = ref[i];
              search_columns.push({
                name: column,
                selected: _this.columns.indexOf(column) !== -1
              });
            }
            _this.search_columns = search_columns;
            _this.all_columns = search_options.columns;
            return _this.search_modes = search_options.modes;
          };
        })(this)
      });
      return this.search();
    },
    search: function() {
      this.users = [];
      return $.ajax({
        url: 'api/System/admin/users',
        type: 'search',
        data: {
          column: this.search_column,
          mode: this.search_mode,
          text: this.search_text,
          page: this.search_page,
          limit: this.search_limit
        },
        success: (function(_this) {
          return function(data) {
            if (!data.count) {
              return;
            }
            data.users.forEach(function(user) {
              var column;
              user["class"] = (function() {
                switch (parseInt(user.status)) {
                  case STATUS_ACTIVE:
                    return 'uk-alert-success';
                  case STATUS_INACTIVE:
                    return 'uk-alert-warning';
                  default:
                    return '';
                }
              })();
              user.is_active = user.status == STATUS_ACTIVE;
              user.is_guest = user.id == GUEST_ID;
              user.is_root = user.id == ROOT_ID;
              user.columns = (function() {
                var i, len, ref, results;
                ref = this.columns;
                results = [];
                for (i = 0, len = ref.length; i < len; i++) {
                  column = ref[i];
                  results.push((function(value) {
                    if (value instanceof Array) {
                      return value.join(', ');
                    } else {
                      return value;
                    }
                  })(user[column]));
                }
                return results;
              }).call(_this);
              return (function() {
                var type;
                type = user.is_root || user.is_admin ? 'a' : user.is_user ? 'u' : user.is_bot ? 'b' : 'g';
                user.type = L[type];
                return user.type_info = L[type + '_info'];
              })();
            });
            return _this.users = data.users;
          };
        })(this)
      });
    },
    domReady: function() {
      this.workarounds(this.shadowRoot);
      return cs.observe_inserts_on(this.shadowRoot, this.workarounds);
    },
    workarounds: function(target) {
      return $(target).cs().tabs_inside().cs().tooltips_inside();
    },
    toggle_search_column: function(event, detail, sender) {
      var column, index;
      index = $(sender).data('column-index');
      column = this.search_columns[index];
      column.selected = !column.selected;
      this.columns = (function() {
        var i, len, ref, results;
        ref = this.search_columns;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          column = ref[i];
          if (column.selected) {
            results.push(column.name);
          }
        }
        return results;
      }).call(this);
      return this.search();
    },
    add_user: function() {
      return $.cs.simple_modal("<h3>" + L.adding_a_user + "</h3>\n<cs-system-admin-users-add-user-form/>").on('hide.uk.modal', this.search.bind(this));
    },
    add_bot: function() {
      return $.cs.simple_modal("<h3>" + L.adding_a_bot + "</h3>\n<cs-system-admin-users-add-bot-form/>").on('hide.uk.modal', this.search.bind(this));
    },
    edit_user: function(event, detail, sender) {
      var $sender, index, title, user;
      $sender = $(sender);
      index = $sender.closest('[data-user-index]').data('user-index');
      user = this.users[index];
      if (user.is_bot) {
        title = L.editing_of_bot_information(user.username || user.login);
        return $.cs.simple_modal("<h2>" + title + "</h2>\n<cs-system-admin-users-edit-bot-form user_id=\"" + user.id + "\"/>").on('hide.uk.modal', this.search.bind(this));
      } else {
        title = L.editing_of_user_information(user.username || user.login);
        return $.cs.simple_modal("<h2>" + title + "</h2>\n<cs-system-admin-users-edit-user-form user_id=\"" + user.id + "\"/>").on('hide.uk.modal', this.search.bind(this));
      }
    },
    edit_permissions: function(event, detail, sender) {
      var $sender, index, title, title_key, user;
      $sender = $(sender);
      index = $sender.closest('[data-user-index]').data('user-index');
      user = this.users[index];
      title_key = user.is_bot ? 'permissions_for_bot' : 'permissions_for_user';
      title = L[title_key](user.username || user.login);
      return $.cs.simple_modal("<h2>" + title + "</h2>\n<cs-system-admin-permissions-for user=\"" + user.id + "\" for=\"user\"/>");
    }
  });

}).call(this);
